apiVersion: batch/v1
kind: CronJob
metadata:
  name: portfolio-analysis
  labels:
    app: portfolio-analysis
    component: worker
spec:
  # Run daily at 8 PM EST (01:00 UTC)
  schedule: "0 1 * * *"
  # Keep last 7 successful and 3 failed jobs for debugging
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  # Prevent concurrent runs (wait for previous job to complete)
  concurrencyPolicy: Forbid
  # Suspend if needed for maintenance
  suspend: false
  jobTemplate:
    spec:
      # Clean up completed jobs after 24 hours
      ttlSecondsAfterFinished: 86400
      # Allow 30 minutes for analysis to complete
      activeDeadlineSeconds: 1800
      template:
        metadata:
          labels:
            app: portfolio-analysis
            component: worker
        spec:
          serviceAccountName: klinematrix-sa
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
          - name: portfolio-analyzer
            image: klinematrix/backend:test
            imagePullPolicy: Always
            command:
            - python
            - scripts/run_portfolio_analysis.py
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                  - ALL
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /app/.cache
            - name: home-cache
              mountPath: /home/app/.cache
            - name: home-local
              mountPath: /home/app/.local
            # Environment variables defined in overlays
            resources:
              requests:
                memory: "512Mi"
                cpu: "500m"
              limits:
                memory: "1Gi"
                cpu: "1000m"
          volumes:
          - name: tmp
            emptyDir: {}
          - name: cache
            emptyDir: {}
          - name: home-cache
            emptyDir: {}
          - name: home-local
            emptyDir: {}
