apiVersion: batch/v1
kind: CronJob
metadata:
  name: insights-snapshot-trigger
  labels:
    app: insights-snapshot
    component: trigger
spec:
  # Run daily at 9:00 AM CST (Beijing) / 01:00 UTC
  schedule: "0 1 * * *"
  # Keep last 7 successful and 3 failed jobs for debugging
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  # Prevent concurrent runs (wait for previous job to complete)
  concurrencyPolicy: Forbid
  # Suspend if needed for maintenance
  suspend: false
  jobTemplate:
    spec:
      # Clean up completed jobs after 24 hours
      ttlSecondsAfterFinished: 86400
      # Allow 5 minutes for HTTP call (should complete in < 10 seconds)
      activeDeadlineSeconds: 300
      template:
        metadata:
          labels:
            app: insights-snapshot
            component: trigger
        spec:
          serviceAccountName: klinematrix-sa
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534  # nobody user
            fsGroup: 65534
          containers:
          - name: trigger
            # Minimal curl image (5MB vs 1.14GB backend image)
            # Using ACR mirror since Docker Hub is blocked in China
            image: financialagent-gxftdbbre4gtegea.azurecr.io/klinecubic/curl:8.5.0
            imagePullPolicy: IfNotPresent
            command:
            - sh
            - -c
            - |
              echo "Insights snapshot trigger starting..."
              echo "Target: http://backend-service:8000/api/admin/insights/trigger-snapshot"

              # Call backend API endpoint
              # The backend will create snapshot as a background task
              HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response.json -s -X POST \
                http://backend-service:8000/api/admin/insights/trigger-snapshot \
                -H "Content-Type: application/json" \
                -H "X-Admin-Secret: ${ADMIN_SECRET}")

              echo "HTTP Response Code: $HTTP_CODE"
              echo "Response Body:"
              cat /tmp/response.json
              echo ""

              # Check if request was successful (2xx status code)
              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                echo "✅ Insights snapshot triggered successfully"
                exit 0
              else
                echo "❌ Failed to trigger insights snapshot"
                exit 1
              fi
            env:
            # Admin secret for authentication
            - name: ADMIN_SECRET
              valueFrom:
                secretKeyRef:
                  name: backend-secrets
                  key: admin-secret
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false  # curl needs to write to /tmp
              runAsNonRoot: true
              runAsUser: 65534
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                memory: "16Mi"   # Minimal - just curl
                cpu: "10m"        # Minimal
              limits:
                memory: "32Mi"
                cpu: "100m"
          # Minimal volumes for curl temp files
          volumes:
          - name: tmp
            emptyDir:
              sizeLimit: 1Mi
