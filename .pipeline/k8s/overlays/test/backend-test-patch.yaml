apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  template:
    spec:
      serviceAccountName: backend-sa
      containers:
      - name: backend
        env:
        - name: ENVIRONMENT
          value: "test"
        - name: LOG_LEVEL
          value: "INFO"
        - name: ENABLE_DEBUG
          value: "false"
        - name: EMAIL_BYPASS_MODE
          value: "false"
        - name: CORS_ORIGINS
          value: '["https://klinematrix.com"]'
        - name: JWT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: jwt-secret-key
        - name: MONGODB_URL
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: mongodb-url
        - name: MONGODB_DATABASE
          value: "klinematrix_test"
        - name: REDIS_URL
          value: "redis://redis-service:6379/0"
        - name: DASHSCOPE_API_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: dashscope-api-key
        - name: TENCENT_SECRET_ID
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: tencent-secret-id
        - name: TENCENT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: tencent-secret-key
        - name: TENCENT_SES_REGION
          value: "ap-guangzhou"
        - name: TENCENT_SES_FROM_EMAIL
          value: "noreply@klinematrix.com"
        - name: TENCENT_SES_FROM_NAME
          value: "Klinematrix"
        - name: TENCENT_SES_TEMPLATE_ID
          value: "37066"
        # Langfuse observability
        - name: LANGFUSE_PUBLIC_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: langfuse-public-key
        - name: LANGFUSE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: langfuse-secret-key
        - name: LANGFUSE_HOST
          value: "https://monitor.klinematrix.com"
        # Test environment resource limits (10 beta users)
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
