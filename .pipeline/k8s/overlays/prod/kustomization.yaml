apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: klinecubic-prod

# Production namespace
namespace: klinematrix-prod

# Base configuration
resources:
# Base resources (excluding Langfuse, namespace, and Azure workload identity)
- ../../base/backend/deployment.yaml
- ../../base/backend/service.yaml
- ../../base/frontend/deployment.yaml
- ../../base/frontend/service.yaml
- ../../base/redis/deployment.yaml
- ../../base/redis/service.yaml
- ../../base/redis/configmap.yaml
- ../../base/redis/secret.yaml
- ../../base/ingress/clusterissuer.yaml
- ../../base/ingress/ingress.yaml
# REMOVED: reconcile-transactions.yaml (deprecated, always errored)
# Use HTTP trigger pattern for portfolio analysis (5MB curl vs 1.14GB backend image)
# See docs/features/portfolio-analysis-cronjob-http.md for details
- ../../base/cronjobs/portfolio-analysis-trigger.yaml
# Daily insights snapshot trigger (9:30 AM ET)
- ../../base/cronjobs/insights-snapshot-trigger.yaml
# Production-specific resources (Alibaba Cloud ACK)
- namespace.yaml
- mongodb-statefulset.yaml
- mongodb-service.yaml
# Note: secrets.yaml references External Secrets Operator (not installed in ACK)
# Secrets are managed manually via kubectl in production
- rbac.yaml
# Langfuse observability stack (ClickHouse on 16GB node for memory-intensive workloads)
# NOTE: langfuse-secrets must be created manually via kubectl (see docs/deployment/secrets-architecture.md)
- ../../base/langfuse/postgres-statefulset.yaml
- ../../base/langfuse/postgres-service.yaml
- ../../base/langfuse/clickhouse-statefulset.yaml
- ../../base/langfuse/clickhouse-service.yaml
- ../../base/langfuse/server-deployment.yaml
- ../../base/langfuse/server-service.yaml
- ../../base/langfuse/worker-deployment.yaml
- ../../base/langfuse/ingress.yaml

# Production environment overrides
patches:
- path: backend-prod-patch.yaml
  target:
    kind: Deployment
    name: backend
- path: frontend-prod-patch.yaml
  target:
    kind: Deployment
    name: frontend
- path: ingress-prod-patch.yaml
  target:
    kind: Ingress
    name: klinematrix-ingress
- path: cronjob-portfolio-trigger-patch.yaml
  target:
    kind: CronJob
    name: portfolio-analysis-trigger
- path: cronjob-insights-trigger-patch.yaml
  target:
    kind: CronJob
    name: insights-snapshot-trigger
# Langfuse production patches (OSS bucket, node affinity, domain)
- path: langfuse-server-prod-patch.yaml
  target:
    kind: Deployment
    name: langfuse-server
- path: langfuse-worker-prod-patch.yaml
  target:
    kind: Deployment
    name: langfuse-worker
- path: langfuse-clickhouse-prod-patch.yaml
  target:
    kind: Deployment
    name: langfuse-clickhouse

# Production image tags (current versions)
images:
- name: klinematrix/backend
  newName: financialagent-gxftdbbre4gtegea.azurecr.io/klinecubic/backend
  newTag: "prod-v0.10.0"
- name: klinematrix/frontend
  newName: financialagent-gxftdbbre4gtegea.azurecr.io/klinecubic/frontend
  newTag: "prod-v0.11.5"

# Resource allocation for production
replicas:
- name: backend
  count: 1
- name: frontend
  count: 1
