# cert-manager DNS Configuration for ACK Clusters
#
# Problem: ACK's internal DNS (CoreDNS) cannot resolve external domains,
# causing cert-manager HTTP-01 self-checks to fail with "no such host" errors.
#
# Solution: Configure cert-manager pods to use Google DNS (8.8.8.8) directly
# for external domain resolution while maintaining cluster DNS for internal services.
#
# Apply with:
#   kubectl patch deployment cert-manager -n cert-manager --patch-file cert-manager-dns-patch.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: cert-manager
  namespace: cert-manager
spec:
  template:
    spec:
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - "8.8.8.8"      # Google DNS primary
          - "8.8.4.4"      # Google DNS secondary
          - "192.168.0.10" # ACK CoreDNS (for internal cluster DNS)
        searches:
          - "cert-manager.svc.cluster.local"
          - "svc.cluster.local"
          - "cluster.local"
      containers:
      - name: cert-manager-controller
        args:
        - --v=2
        - --cluster-resource-namespace=$(POD_NAMESPACE)
        - --leader-election-namespace=cert-manager
        - --acme-http01-solver-image=quay.io/jetstack/cert-manager-acmesolver:v1.19.1
        - --max-concurrent-challenges=60
        - --dns01-recursive-nameservers=8.8.8.8:53,8.8.4.4:53
        - --dns01-recursive-nameservers-only=true
