# External Secrets Operator - Azure Key Vault Integration
#
# This file configures External Secrets to sync secrets from Azure Key Vault
# Requires: External Secrets Operator installed in cluster
#
# Azure Key Vault credentials will be stored as Kubernetes Secret
# then referenced by SecretStore

---
# Placeholder for Azure Key Vault credentials
# This secret needs to be created manually with:
# kubectl create secret generic azure-keyvault-credentials \
#   --from-literal=client-id=<AZURE_CLIENT_ID> \
#   --from-literal=client-secret=<AZURE_CLIENT_SECRET> \
#   -n klinematrix-prod
#
# Or using External Secrets Operator's direct authentication

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault
  namespace: klinematrix-prod
spec:
  provider:
    azurekv:
      tenantId: "YOUR_TENANT_ID"  # To be updated
      vaultUrl: "https://YOUR_KEYVAULT.vault.azure.net/"  # To be updated
      authType: ServicePrincipal
      authSecretRef:
        clientId:
          name: azure-keyvault-credentials
          key: client-id
        clientSecret:
          name: azure-keyvault-credentials
          key: client-secret

---
# MongoDB root password from Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mongodb-secret
  namespace: klinematrix-prod
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault
    kind: SecretStore
  target:
    name: mongodb-secret
    creationPolicy: Owner
  data:
  - secretKey: mongodb-root-password
    remoteRef:
      key: mongodb-root-password

---
# Backend secrets from Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: backend-secrets
  namespace: klinematrix-prod
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault
    kind: SecretStore
  target:
    name: backend-secrets
    creationPolicy: Owner
  data:
  - secretKey: mongodb-url
    remoteRef:
      key: mongodb-url-prod
  - secretKey: redis-url
    remoteRef:
      key: redis-url-prod
  - secretKey: dashscope-api-key
    remoteRef:
      key: dashscope-api-key
  - secretKey: tencent-secret-id
    remoteRef:
      key: tencent-secret-id
  - secretKey: tencent-secret-key
    remoteRef:
      key: tencent-secret-key
  - secretKey: jwt-secret
    remoteRef:
      key: jwt-secret
  - secretKey: alpaca-api-key
    remoteRef:
      key: alpaca-api-key-test
  - secretKey: alpaca-secret-key
    remoteRef:
      key: alpaca-secret-key-test
  - secretKey: polygon-api-key
    remoteRef:
      key: polygon-api-key-test
  - secretKey: alpha-vantage-api-key
    remoteRef:
      key: alpha-vantage-api-key-prod
