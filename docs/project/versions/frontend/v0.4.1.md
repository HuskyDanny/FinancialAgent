# frontend v0.4.1

**Release Date**: 2025-10-07
**Docker Image**: `financial-agent/frontend:0.4.1`

## Overview

Persistent chat history system with MongoDB integration, allowing users to save, restore, and navigate between conversations. Implements ChatGPT-like chat sidebar with glassmorphism UI design.

## Features Added

### Chat History System
- **ChatSidebar Component** (`src/components/chat/ChatSidebar.tsx`)
  - Glassmorphism design matching KlineMatrix aesthetic
  - Chat list with pagination (20 chats per page)
  - New Chat button for starting fresh conversations
  - Archive toggle for viewing archived chats
  - Real-time loading states and error handling

- **ChatListItem Component** (`src/components/chat/ChatListItem.tsx`)
  - Individual chat item with title, preview, and timestamp
  - Relative time formatting ("5m ago", "2h ago", "3d ago")
  - Active chat highlighting with gradient border
  - Truncated message preview (2 lines max)

### React Query Integration
- **Chat Hooks** (`src/hooks/useChats.ts`)
  - `useChats` - Fetch paginated chat list with 5-minute cache
  - `useChatDetail` - Fetch chat with messages for state restoration
  - `useUpdateUIState` - Optimistic UI state updates with rollback
  - `useOptimisticChatAdd` - Instant new chat addition to cache
  - `useUpdateChatTitle` - Title updates across all query caches

### API Services
- **Type Definitions** (`src/types/api.ts`)
  - `UIState` - Chart state restoration (symbol, interval, overlays)
  - `Chat`, `Message` - Core data models matching backend
  - `ChatListResponse`, `ChatDetailResponse` - API response types
  - `StreamEvent` - Server-Sent Events typing

- **Chat API** (`src/services/api.ts`)
  - `listChats()` - Fetch paginated chat list with filters
  - `getChatDetail()` - Fetch chat with messages
  - `updateUIState()` - Debounced UI state updates
  - `sendMessageStreamPersistent()` - Streaming with MongoDB persistence

### UI Integration
- **EnhancedChatInterface** - Integrated sidebar (342 lines, under 500 limit)
  - 3-panel layout: Sidebar (280px) | Chat | Chart
  - Chat selection handler with state restoration placeholder
  - New chat handler resetting all state
  - Active chat highlighting

## Architecture Decisions

✅ **Modular Components** - Sidebar split into 2 files (114 + 100 lines)
✅ **Optimistic Updates** - Instant UI feedback with automatic rollback
✅ **Query Key Structure** - Hierarchical keys for precise invalidation
✅ **5-Minute Cache** - Balance between freshness and API calls

## Bug Fixes

None (new feature release)

## Breaking Changes

None - Backward compatible with v0.4.0

## Compatibility

| Component | Required Version |
|-----------|-----------------|
| Backend API | v0.4.0+ |
| React | 18.2.0+ |
| React Query | 5.10.0+ |
| TypeScript | 5.2.2+ |

## File Line Counts (All Under 500)

| File | Lines | Status |
|------|-------|--------|
| `ChatSidebar.tsx` | 114 | ✅ |
| `ChatListItem.tsx` | 100 | ✅ |
| `useChats.ts` | ~180 | ✅ |
| `EnhancedChatInterface.tsx` | 342 | ✅ |
| `api.ts` | ~410 | ✅ |

## Known Issues

- TODO: Chat selection does not yet load messages from MongoDB (placeholder)
- TODO: UI state restoration from chat.ui_state not implemented
- TODO: Title updates from stream events not wired to cache hooks

## Next Steps

1. Implement chat message loading in `handleChatSelect`
2. Wire up UI state restoration from `chat.ui_state`
3. Connect title generation events to `useUpdateChatTitle` hook
4. Add debounced UI state sync to MongoDB
5. Implement archive/delete chat functionality
