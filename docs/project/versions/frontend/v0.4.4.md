# Frontend v0.4.4

**Release Date**: 2025-10-07
**Status**: Current
**Previous Version**: [v0.4.3](v0.4.3.md)

## Overview

Bug fix release addressing massive request spam when switching between chats.

## Changes

### Bug Fixes

#### Prevent Concurrent Chat Restoration
- **Issue**: Massive OPTIONS preflight request spam (10+ per second) when switching chats rapidly
- **Root Cause**: No concurrent request protection allowing overlapping chat restoration requests
- **Solution**: Added `isRestoringRef` flag to prevent concurrent execution
- **Impact**: Single chat detail request per selection (was 10+)
- **Files**: `frontend/src/components/EnhancedChatInterface.tsx`

#### Optimize React Query Refetch Behavior
- **Issue**: useChatDetail aggressively refetching on mount/focus/reconnect
- **Solution**: Disabled unnecessary refetch triggers, rely on manual invalidations and staleTime
- **Impact**: Reduced OPTIONS preflight spam, better network efficiency
- **Files**: `frontend/src/hooks/useChats.ts`

## Technical Details

### Before (Buggy)
```typescript
const handleChatSelect = useCallback(
  (chatId: string) => {
    restoreChat(chatId); // Multiple calls possible
  },
  [restoreChat],
);
```

### After (Fixed)
```typescript
const isRestoringRef = useRef(false);

const handleChatSelect = useCallback(
  async (chatId: string) => {
    // Prevent concurrent restoration requests
    if (isRestoringRef.current) {
      console.log("⏭️ Skipping chat select: restoration in progress");
      return;
    }

    isRestoringRef.current = true;
    try {
      await restoreChat(chatId);
    } finally {
      isRestoringRef.current = false;
    }
  },
  [restoreChat],
);
```

### Query Optimization
```typescript
export function useChatDetail(chatId: string | null, limit?: number) {
  return useQuery({
    queryKey: chatId ? chatKeys.detail(chatId) : [],
    queryFn: () => {
      if (!chatId) throw new Error("Chat ID is required");
      return chatService.getChatDetail(chatId, limit);
    },
    enabled: !!chatId,
    staleTime: 2 * 60 * 1000,
    gcTime: 5 * 60 * 1000,
    refetchOnMount: false,      // NEW: Prevent refetch on mount
    refetchOnWindowFocus: false, // NEW: Prevent refetch on focus
    refetchOnReconnect: false,   // NEW: Prevent refetch on reconnect
  });
}
```

## Migration Notes

### Breaking Changes
None. Fully backward compatible.

### Deployment Steps
```bash
# 1. Build new image
az acr build --registry financialAgent \
  --image financial-agent/frontend:0.4.4 \
  --target production \
  --file frontend/Dockerfile frontend/

# 2. Update kustomization.yaml image tag
# Edit: .pipeline/k8s/overlays/test/kustomization.yaml
# Change: newTag: "test-v0.4.4"

# 3. Restart pods
kubectl delete pod -l app=frontend -n klinematrix-test

# 4. Verify backend logs
kubectl logs -f deployment/backend -n klinematrix-test
# Should see clean request flow:
# INFO: Chat detail retrieved {"chat_id": "...", "message_count": 1}
# INFO: GET /api/chat/chats/... HTTP/1.1" 200 OK
# INFO: GET /api/market/price/... HTTP/1.1" 200 OK
# (Single request per chat selection, not 10+)
```

## Compatibility

| Component | Compatible Versions |
|-----------|-------------------|
| Backend | v0.4.1, v0.4.2 |
| React | 18.x |
| TypeScript | 5.x |
| Node.js | 20.x+ |

## Performance Metrics

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| Requests per chat selection | 10+ | 1 | 90% reduction |
| OPTIONS spam | Yes | No | 100% eliminated |
| Concurrent requests | Possible | Blocked | ✅ Protected |

## Verification

### Expected Behavior
```bash
# Backend logs (healthy):
INFO: Chat detail retrieved {"chat_id": "chat_b30b1155b888", "message_count": 1}
INFO: GET /api/chat/chats/chat_b30b1155b888 HTTP/1.1" 200 OK
INFO: GET /api/market/price/MSFT?interval=1d&period=6mo HTTP/1.1" 200 OK

# Browser console (if rapid clicking):
⏭️ Skipping chat select: restoration in progress
```

### Unhealthy Behavior (Fixed)
```bash
# Before v0.4.4 (bad):
INFO: OPTIONS /api/chat/chats/chat_01a08def1afc HTTP/1.1" 200 OK
INFO: OPTIONS /api/chat/chats/chat_01a08def1afc HTTP/1.1" 200 OK
INFO: OPTIONS /api/chat/chats/chat_01a08def1afc HTTP/1.1" 200 OK
... (repeating 10+ times)
```

## Known Issues
None.

## Contributors
- Claude Code (automated fixes)

## Related Issues
- Concurrent request spam (fixed)
- React Query refetch optimization

## Next Version
TBD
