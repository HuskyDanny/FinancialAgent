# Frontend v0.4.3

**Release Date**: 2025-10-07
**Status**: Current
**Previous Version**: [v0.4.2](v0.4.2.md)

## Overview

Critical performance fix release addressing render loop causing laggy typing experience in chat input.

## Changes

### Performance Fixes

#### Resolve Render Loop in Chat Input
- **Issue**: Typing in chat input triggered 6+ renders per keystroke, causing poor performance
- **Root Cause**: Unstable object references (`selectedDateRange`) and callbacks recreated on every render
- **Solution**:
  - Split object state into primitives (`dateRangeStart`, `dateRangeEnd`)
  - Memoized derived `selectedDateRange` object with `useMemo`
  - Stabilized all event handlers with `useCallback`
  - Used stable `.mutate` references in dependencies
- **Impact**: Reduced renders from 6+ per keystroke to 1 per keystroke
- **Files**:
  - `frontend/src/components/EnhancedChatInterface.tsx`
  - `frontend/src/hooks/useUIStateSync.ts`
  - `frontend/src/components/chat/useChatManager.ts`

#### Optimize UI State Sync
- **Issue**: UI state synced to DB immediately after chat restoration even though no changes
- **Solution**: Added detection for chat change, skip sync on first render after restoration
- **Impact**: Eliminated unnecessary write-after-read operations
- **Files**: `frontend/src/hooks/useUIStateSync.ts`

### Bug Fixes

#### Fix Chat Manager State Naming
- **Issue**: Inconsistent naming between `sessionId` and `chatId`
- **Solution**: Renamed `sessionId` → `chatId` for consistency with API
- **Impact**: Clearer code, aligned with backend terminology
- **Files**: `frontend/src/components/chat/useChatManager.ts`

### Backend Coordination

#### Reduce Duplicate Query Invalidations
- **Issue**: Chat list invalidated multiple times during stream (on create + on complete)
- **Solution**: Only invalidate once after stream completes
- **Impact**: Reduced unnecessary API calls
- **Files**: `frontend/src/components/chat/useAnalysis.ts`

## Technical Details

### Before (Buggy)
```typescript
// Object recreated every render
const [selectedDateRange, setSelectedDateRange] = useState({ start: "", end: "" });

// New function every render
const handleSymbolSelect = (symbol: string, name: string) => { ... };
```

### After (Fixed)
```typescript
// Primitives don't trigger object recreation
const [dateRangeStart, setDateRangeStart] = useState("");
const [dateRangeEnd, setDateRangeEnd] = useState("");

// Memoized - only recreates when primitives change
const selectedDateRange = useMemo(
  () => ({ start: dateRangeStart, end: dateRangeEnd }),
  [dateRangeStart, dateRangeEnd],
);

// Stable callback
const handleSymbolSelect = useCallback((symbol: string, name: string) => {
  setCurrentSymbol(symbol);
  setCurrentCompanyName(name);
  setDateRangeStart("");
  setDateRangeEnd("");
}, []);
```

## Migration Notes

### Breaking Changes
None. Fully backward compatible.

### Deployment Steps
```bash
# 1. Build new image
az acr build --registry financialAgent \
  --image financial-agent/frontend:0.4.3 \
  --target production \
  --file frontend/Dockerfile frontend/

# 2. Update kustomization.yaml image tag
# Edit: .pipeline/k8s/overlays/test/kustomization.yaml
# Change: newTag: "test-v0.4.3"

# 3. Restart pods
kubectl delete pod -l app=frontend -n klinematrix-test

# 4. Verify
curl https://klinematrix.com
# Open browser console, type in chat input
# Should see: ✅ Render #1 (1 in last 1s)
```

## Compatibility

| Component | Compatible Versions |
|-----------|-------------------|
| Backend | v0.4.1, v0.4.2 |
| React | 18.x |
| TypeScript | 5.x |
| Node.js | 20.x+ |

## Performance Metrics

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| Renders per keystroke | 6+ | 1 | 83% reduction |
| Typing lag | Noticeable | None | ✅ Resolved |
| Unnecessary syncs | Yes | No | 100% eliminated |

## Known Issues
- Chat sidebar request spam when rapidly switching chats (fixed in v0.4.4)

## Contributors
- Claude Code (automated fixes)

## Related Issues
- Render loop performance degradation (fixed)
- UI state sync optimization

## Next Version
[v0.4.4](v0.4.4.md)
