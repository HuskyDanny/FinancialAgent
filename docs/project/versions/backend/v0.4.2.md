# Backend v0.4.2

**Release Date**: 2025-10-07
**Status**: Current
**Previous Version**: [v0.4.1](v0.4.1.md)

## Overview

Critical bug fix release addressing backend startup failure and database query optimization.

## Changes

### Bug Fixes

#### Remove chat_legacy Router Import
- **Issue**: Backend failing to start with `ModuleNotFoundError: No module named 'src.api.chat_legacy'`
- **Root Cause**: main.py still importing chat_legacy_router which was removed during MongoDB persistent chat migration
- **Solution**: Removed chat_legacy import and router registration from main.py
- **Impact**: Backend now starts successfully without import errors
- **Files**: `backend/src/main.py`

### Performance Improvements

#### Optimize MongoDB Compound Index
- **Issue**: Two separate indexes for chat queries (user_id + last_message_at, user_id + is_archived)
- **Solution**: Combined into single optimal compound index: `user_id + is_archived + last_message_at`
- **Impact**: Better query performance for chat list with archive filtering
- **Benefit**: Single index covers all query patterns, reduced index maintenance overhead
- **Files**: `backend/scripts/init_indexes.py`

## Migration Notes

### Breaking Changes
None.

### Deployment Steps
```bash
# 1. Build new image
az acr build --registry financialAgent \
  --image financial-agent/backend:0.4.2 \
  --file backend/Dockerfile backend/

# 2. Update kustomization.yaml image tag
# Edit: .pipeline/k8s/overlays/test/kustomization.yaml
# Change: newTag: "test-v0.4.2"

# 3. Restart pods
kubectl delete pod -l app=backend -n klinematrix-test

# 4. Verify health
curl https://klinematrix.com/api/health
```

### Database Changes
MongoDB indexes will be recreated on next deployment. No manual migration required.

## Compatibility

| Component | Compatible Versions |
|-----------|-------------------|
| Frontend | v0.4.3, v0.4.4 |
| MongoDB | 7.0+ |
| Redis | 7.2+ |
| Python | 3.12+ |

## Known Issues
None.

## Contributors
- Claude Code (automated fixes)

## Related Issues
- Backend startup loop (fixed)
- MongoDB query optimization

## Next Version
[v0.4.3](v0.4.3.md) (if exists)
