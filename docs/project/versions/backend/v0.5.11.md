# Backend v0.5.11

**Release Date**: 2025-10-31
**Docker Image**: `financial-agent/backend:0.5.11`

## Overview

This release adds image upload functionality for feedback submissions using Alibaba Cloud OSS. Users can now attach up to 5 images to feedback items, with images displayed inline in the detail view. The implementation uses a presigned URL pattern for secure, direct-to-OSS uploads without backend bandwidth overhead.

## Features Added

- **OSS Image Upload Service**: New `OSSService` class for managing Alibaba Cloud OSS operations
  - Presigned URL generation for direct browser uploads (5-minute expiration)
  - Secure object key generation with date-based organization
  - Image validation (PNG, JPEG, GIF, WebP, max 10MB)
  - Public URL generation for image access
- **Feedback Image Upload API**: New `/api/feedback/upload-image` endpoint
  - Returns presigned upload URL and public URL
  - Rate limiting: 10 uploads per minute per user
  - Content-type validation
- **Feedback Model Enhancement**: Added `image_urls` field to feedback models
  - Support up to 5 images per feedback item
  - Array field in MongoDB for storing OSS URLs
- **OSS Bucket Creation Script**: Utility script for bucket setup
  - Creates bucket with proper ACL (public-read)
  - Configures CORS for browser uploads
  - Reads credentials from environment variables

## Security Improvements

- **Credential Management**: Removed hardcoded OSS credentials
  - Bucket creation script reads from environment variables
  - Proper error handling when credentials are missing
- **Filename Sanitization**: Improved filename cleaning with regex pattern
  - Changed from simple space replacement to comprehensive sanitization
  - Pattern: `[^\w\-.]` replaced with underscore
  - Prevents path traversal and special character issues

## Technical Details

**New Dependencies**:
- `oss2>=2.18.0` - Alibaba Cloud OSS Python SDK

**Configuration** (`.env.development`):
```bash
OSS_ACCESS_KEY=<your-access-key>
OSS_SECRET_KEY=<your-secret-key>
OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com
OSS_BUCKET=financial-agent-feedback
```

**File Organization**:
- New files stored as: `feedback/{date}/{user_id}/{hash}_{filename}`
- Example: `feedback/2025/10/31/user_57dde4922766/3aef0b5f4608_image.png`

**Rate Limiting**:
- Image uploads: 10 per minute per user
- Feedback creation: 3 per hour per user (existing)

## Breaking Changes

None

## Compatibility

| Component | Required Version | Notes |
|-----------|-----------------|-------|
| Frontend | v0.8.14+ | Required for image upload widget |
| MongoDB | 4.4+ | Uses array field for image_urls |
| Redis | 6.0+ | For rate limiting |
| OSS Bucket | public-read ACL | Images must be publicly accessible |

## Known Issues

**Performance Considerations** (Low Priority):
- OSS service instance created per request (could be cached)
- No image compression before upload (10MB max)
- Sequential file uploads in frontend (could parallelize)

**Future Enhancements**:
- Image compression/resizing before upload
- Thumbnail generation for faster loading
- OSS service caching/singleton pattern
- Parallel upload support for multiple images

## Migration Guide

**For Local Development**:

1. Add OSS credentials to `backend/.env.development`:
   ```bash
   OSS_ACCESS_KEY=<your-key>
   OSS_SECRET_KEY=<your-secret>
   OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com
   OSS_BUCKET=financial-agent-feedback
   ```

2. Create OSS bucket (if not exists):
   ```bash
   cd backend
   OSS_ACCESS_KEY=<your-key> OSS_SECRET_KEY=<your-secret> python scripts/create_feedback_bucket.py
   ```

3. Restart backend container:
   ```bash
   docker compose restart backend
   ```

**For Test/Prod Deployment**:

1. Add OSS credentials to Azure Key Vault:
   ```bash
   az keyvault secret set --vault-name <vault-name> --name oss-access-key --value "<your-key>"
   az keyvault secret set --vault-name <vault-name> --name oss-secret-key --value "<your-secret>"
   ```

2. Update External Secrets to sync OSS credentials

3. Deploy backend v0.5.11 and frontend v0.8.14 together

**No database migration required** - `image_urls` field defaults to empty array.
