# Backend v0.4.7

**Release Date**: 2025-10-08
**Docker Image**: `klinematrix/backend:test-v0.4.7`

## Overview

Production-ready JWT authentication with dual-token security (access + refresh tokens). Implements token rotation, revocation, and device tracking for secure session management.

## Features Added

### üîê Dual-Token JWT Authentication

**Core Models & Services**:
- `RefreshToken` model: Token hash, expiry, revocation status, device tracking (user-agent, IP)
- `RefreshTokenRepository`: CRUD operations with MongoDB indexes (token_hash unique, user_id, expires_at)
- `TokenService`: Token pair creation, refresh with rotation, revocation (single + all)

**API Endpoints**:
- `POST /api/auth/refresh`: Refresh access token (auto-rotates refresh token)
- `POST /api/auth/logout`: Revoke single refresh token
- `POST /api/auth/logout-all`: Revoke all user's refresh tokens
- Updated `POST /api/auth/login`: Now returns token pair (access + refresh)
- Updated `POST /api/auth/register`: Now returns token pair
- Updated `POST /api/auth/reset-password`: Now returns token pair

**Security Features**:
- **Short-lived access tokens**: 30 minutes (reduced from 7 days)
- **Long-lived refresh tokens**: 7 days with rotation
- **Token rotation**: New refresh token issued on each access token refresh
- **SHA-256 hashing**: Refresh tokens stored as hashes in database
- **Device tracking**: User-agent and IP address logged per token
- **Revocation capability**: Logout from single device or all devices
- **Database indexes**: Efficient token lookups and expiry queries

**LoginResponse Schema** (Breaking Change):
```python
{
  "access_token": "...",
  "refresh_token": "...",  # NEW
  "token_type": "bearer",
  "expires_in": 1800,       # NEW (seconds)
  "refresh_expires_in": 604800,  # NEW (seconds)
  "user": {...}
}
```

## Bug Fixes

None

## Breaking Changes

### ‚ö†Ô∏è LoginResponse Schema Changed

**Old response** (v0.4.6 and earlier):
```json
{
  "access_token": "...",
  "token_type": "bearer",
  "user": {...}
}
```

**New response** (v0.4.7+):
```json
{
  "access_token": "...",
  "refresh_token": "...",
  "token_type": "bearer",
  "expires_in": 1800,
  "refresh_expires_in": 604800,
  "user": {...}
}
```

**Frontend must**:
1. Store both `access_token` and `refresh_token` in localStorage
2. Implement token refresh flow before access token expires
3. Update logout to call `/api/auth/logout` with refresh token

## Compatibility

| Component | Required Version |
|-----------|-----------------|
| Frontend | v0.6.2+ (implements token refresh flow) |
| MongoDB | Any (new collection: refresh_tokens) |
| Python | 3.12+ |
| FastAPI | 0.115.6+ |
| python-jose | 3.3.0+ (JWT handling) |

## Known Issues

None

## Migration Guide

### For Frontend Integration

1. **Update login/register/reset-password handlers**:
```typescript
// Old (v0.4.6)
const { access_token, user } = await response.json();
localStorage.setItem('token', access_token);

// New (v0.4.7)
const { access_token, refresh_token, user } = await response.json();
localStorage.setItem('access_token', access_token);
localStorage.setItem('refresh_token', refresh_token);
```

2. **Implement token refresh flow**:
```typescript
// Before each authenticated request
if (isAccessTokenExpiringSoon()) {
  const newTokens = await fetch('/api/auth/refresh', {
    method: 'POST',
    body: JSON.stringify({ refresh_token: localStorage.getItem('refresh_token') })
  });
  // Update stored tokens
}
```

3. **Update logout**:
```typescript
// Old (v0.4.6)
localStorage.removeItem('token');

// New (v0.4.7)
await fetch('/api/auth/logout', {
  method: 'POST',
  body: JSON.stringify({ refresh_token: localStorage.getItem('refresh_token') })
});
localStorage.removeItem('access_token');
localStorage.removeItem('refresh_token');
```

### Database Migration

**No action required** - Indexes are created automatically on startup via `lifespan` in `main.py`.

**Collection created**: `refresh_tokens`
**Indexes**:
- `token_hash` (unique)
- `user_id`
- `expires_at`
- Composite: `(user_id, revoked)`

## Security Improvements

- **Reduced attack window**: Access token valid for 30 min (was 7 days)
- **Revocation support**: Stolen tokens can be revoked in database
- **Token rotation**: Automatic rotation on refresh prevents reuse attacks
- **Device tracking**: Monitor login locations and devices
- **Logout-all**: Remotely invalidate all sessions if device compromised
