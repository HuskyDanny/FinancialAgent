# Backend v0.4.9

**Release Date**: 2025-10-09
**Docker Image**: `financial-agent/backend:0.4.9`

## Overview

Security enhancement implementing atomic token rotation using MongoDB transactions to prevent race conditions during refresh token renewal.

## Features Added

- **Atomic Token Rotation**: New `RefreshTokenRepository.rotate_token_atomic()` method that uses MongoDB transactions to atomically revoke old refresh token and create new token in a single operation
- **Graceful Fallback**: Automatic fallback to non-atomic operations when transactions are not supported (standalone MongoDB in local development)
- **Production Ready**: Full transaction support in production environment (Azure Cosmos DB with MongoDB API)

## Bug Fixes

- Fixed potential race condition where refresh token could be revoked but new token creation fails, leaving user locked out
- Added proper error handling with `raise ... from None` to comply with B904 linting rules

## Technical Details

### What Changed

**`RefreshTokenRepository` (refresh_token_repository.py:150-266)**:
- Added `rotate_token_atomic()` method with MongoDB transaction support
- Implements try-catch pattern: attempts transactional approach first, falls back to sequential operations if transactions unavailable
- Proper error propagation for token validation errors vs. transaction errors

**`TokenService` (token_service.py:207-236)**:
- Updated `refresh_access_token()` to use atomic rotation method
- Replaced separate `revoke_by_hash()` + `create()` calls with single `rotate_token_atomic()` call

### Why

Without atomic operations, there's a critical window where:
1. Old refresh token gets revoked ✅
2. Network/DB failure occurs ❌
3. New token never gets created ❌
4. User is locked out (no valid tokens)

Atomic transactions ensure both operations succeed together or fail together.

### How It Works

**Production (Cosmos DB - Replica Set)**:
```python
async with session.start_transaction():
    # 1. Verify old token valid
    # 2. Revoke old token
    # 3. Create new token
    # Transaction commits atomically
```

**Local Dev (Standalone MongoDB)**:
```python
# Catches "Transaction numbers not allowed" error
# Falls back to sequential operations (best effort)
# Logs warning with recommendation
```

## Breaking Changes

None - fully backward compatible.

## Compatibility

| Component | Required Version | Notes |
|-----------|-----------------|-------|
| MongoDB | 3.6+ (replica set) or 4.0+ (standalone) | Transactions require replica set in MongoDB; Cosmos DB supports by default |
| Frontend | Any | No frontend changes required |

## Known Issues

**Local Development**: Standalone MongoDB (docker-compose) doesn't support transactions without replica set configuration. Operation uses non-atomic fallback but is functionally equivalent for single-user dev environment.

**Recommendation**: Production environments should use Azure Cosmos DB or MongoDB replica sets for full atomic guarantees.

## Migration Guide

No migration required. Existing refresh token flows continue to work. The change is transparent to API clients.

## Testing

Verified with:
- Local token refresh: ✅ Non-atomic fallback works correctly
- Database verification: ✅ Old token revoked, new token created
- Logs confirmation: ✅ Warning logged for non-replica-set environments

Production deployment will automatically use transactional path.
