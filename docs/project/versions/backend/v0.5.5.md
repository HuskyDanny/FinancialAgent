# Backend v0.5.5

**Release Date**: 2025-10-24
**Docker Image**: `klinematrix/backend:test-v0.5.5`

## Overview

Critical fix for Cosmos DB MongoDB API compatibility. Resolves 500 errors on `/api/chat/chats` endpoint by changing query sorting from `_id` to `updated_at` field. This is a **production-critical fix** that addresses the fundamental difference between regular MongoDB and Cosmos DB's MongoDB API.

## Bug Fixes

### Critical: Cosmos DB Query Sorting Incompatibility

**Problem**: The `/api/chat/chats` endpoint was returning 500 Internal Server Error with the message:
```
Error=2, Details='Response status code does not indicate success: BadRequest (400);
Reason: {"Errors":["The index path corresponding to the specified order-by item is excluded."]}
```

**Root Cause**: Cosmos DB MongoDB API **does NOT support sorting by `_id`** when using compound filter queries, even with compound indexes. The comment in `chat_repository.py` claiming "Sorting by _id (always indexed) for Cosmos DB compatibility" was incorrect.

**Fix**: Changed chat list query from:
```python
# BEFORE (fails in Cosmos DB):
collection.find({"user_id": user_id, "is_archived": False}).sort("_id", -1)

# AFTER (works in both MongoDB and Cosmos DB):
collection.find({"user_id": user_id, "is_archived": False}).sort("updated_at", -1)
```

**Database Update**: Updated Cosmos DB compound index from `["user_id", "is_archived", "_id"]` to `["user_id", "is_archived", "updated_at"]`

**Files Changed**:
- `backend/src/database/repositories/chat_repository.py:114` - Changed sort field
- Cosmos DB `chats` collection index - Updated compound index

**Why This Matters**:
- **Local Dev (MongoDB)**: Worked fine with `_id` sorting
- **Test/Prod (Cosmos DB)**: Failed with `_id` sorting, required `updated_at`
- This issue only manifests in production, not in local development

**Testing**: Verified with:
```bash
kubectl logs deployment/backend -n klinematrix-test | grep "GET /api/chat/chats"
# Result: 200 OK (previously 500 Internal Server Error)
```

**Reference**: See [Cosmos DB MongoDB Compatibility Guide](../../../deployment/cosmos-db-mongodb-compatibility.md)

## Documentation Added

1. **New**: `docs/deployment/cosmos-db-mongodb-compatibility.md`
   - Comprehensive guide on Cosmos DB MongoDB API limitations
   - Migration checklist from MongoDB to Cosmos DB
   - Query patterns and index requirements

2. **Updated**: `docs/troubleshooting/mongodb-cosmos-db.md`
   - Added "Sorting with Compound Filters - CRITICAL LIMITATION" section
   - Examples of what fails vs. what works
   - Why the issue occurs

## Breaking Changes

None

## Compatibility

| Component | Version | Notes |
|-----------|---------|-------|
| Cosmos DB MongoDB API | v4.2 | Requires compound indexes with sort fields |
| Python | 3.12 | No changes |
| Motor (MongoDB driver) | 3.7.1 | No changes |
| Frontend | 0.6.1+ | No changes required |

## Known Issues

None

## Migration Guide

**If migrating from regular MongoDB to Cosmos DB MongoDB API:**

1. **Audit all queries** using `.sort("_id", ...)` with filter conditions
2. **Replace** `_id` sorting with explicit timestamp fields (`created_at`, `updated_at`, `timestamp`)
3. **Create compound indexes** that include both filter fields AND sort fields
4. **Test thoroughly** - Cosmos DB errors appear at runtime, not at schema creation

**For this specific fix**, no manual migration needed - the Cosmos DB index has already been updated via Azure CLI.

## Deployment Notes

**Deployment Steps (Already Completed)**:
```bash
# 1. Built image
az acr build --registry financialAgent --image klinematrix/backend:test-v0.5.5 --file backend/Dockerfile backend/

# 2. Updated kustomization.yaml
newTag: "test-v0.5.5"

# 3. Applied changes
kubectl apply -k .pipeline/k8s/overlays/test/

# 4. Restarted pods
kubectl delete pod -l app=backend -n klinematrix-test
```

**Verification**:
```bash
# Check logs for successful chat list requests
kubectl logs deployment/backend -n klinematrix-test | grep "GET /api/chat/chats"
# Expected: 200 OK
```

**Rollback** (if needed):
```bash
# Revert to v0.4.5
kubectl patch deployment backend -n klinematrix-test -p '{"spec":{"template":{"spec":{"containers":[{"name":"backend","image":"financialagent-gxftdbbre4gtegea.azurecr.io/klinematrix/backend:test-v0.4.5"}]}}}}'
```

## Related Issues

- Fixed in response to production 500 errors on `/api/chat/chats`
- Addresses the fundamental incompatibility between MongoDB and Cosmos DB's MongoDB API
- Ensures code works in both local dev (MongoDB) and production (Cosmos DB)
