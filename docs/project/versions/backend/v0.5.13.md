# Backend v0.5.13

**Release Date**: 2025-11-06
**Docker Image**: `klinematrix/backend:test-v0.5.13`
**Commit**: 923a383

## Overview

Critical bug fix release addressing portfolio chart timeout, order persistence, and agent recursion limits. This release resolves blocking issues preventing portfolio data visualization and complex agent queries.

## Features Added

None (bug fix release)

## Bug Fixes

### Portfolio Chart Timeout Fix
- **File**: `backend/src/services/alpaca_trading_service.py:469-471`
- **Problem**: Synchronous `get_portfolio_history()` call blocked async event loop, causing 30s timeouts
- **Solution**: Wrapped with `asyncio.to_thread()` to run in thread executor
- **Impact**: Portfolio history endpoint now returns in <1s instead of timing out
- **Verification**: Chart displays 79 intraday data points successfully

### Order Persistence Infrastructure
- **Files Created**: `backend/src/database/repositories/portfolio_order_repository.py` (311 lines)
- **Files Modified**: `backend/src/main.py:112-119,185`, `backend/src/services/watchlist_analyzer.py:36,45,217-221`
- **Problem**: Orders placed via Alpaca API but never persisted to MongoDB (6 orders in Alpaca, 0 in database)
- **Solution**:
  - Created `PortfolioOrderRepository` with 5 optimized indexes
  - Wired repository to `WatchlistAnalyzer` for automatic persistence
  - Added `order_repository.create(order)` call after order placement
- **Impact**: All orders now persist to MongoDB with full audit trail (analysis_id linkage)
- **Indexes Created**:
  - `idx_user_orders`: (user_id, created_at) - List user orders by time
  - `idx_analysis_orders`: (analysis_id) - Audit trail linkage
  - `idx_alpaca_order`: (alpaca_order_id) - Unique, prevents duplicates
  - `idx_user_status_orders`: (user_id, status, created_at) - Filter by status
  - `idx_user_symbol_orders`: (user_id, symbol, created_at) - Symbol-specific history

### Agent Recursion Limit Increase
- **File**: `backend/src/agent/langgraph_react_agent.py:437`
- **Problem**: Complex queries (e.g., "analyze coreweave") hit 25-iteration limit causing `GraphRecursionError`
- **Solution**: Increased `recursion_limit` from 25 to 50 in agent config
- **Impact**: Agent can now complete complex multi-tool analyses without timeout
- **Verification**: Chat messages appear in UI after agent completes analysis

### Tool Execution Tracking Initialization
- **Files Modified**: `backend/src/main.py:137-141,149`, `backend/src/api/dependencies/chat_deps.py:113-118`
- **Problem**: `ToolCacheWrapper` not initialized at application startup
- **Solution**: Added initialization in `main.py` lifespan and passed to agent
- **Note**: Full integration limited by architectural mismatch (LangGraph autonomous tool management vs. explicit wrapper context)
- **Recommendation**: Use Langfuse for tool observability (already integrated)

## Breaking Changes

None

## Compatibility

| Component | Required Version | Notes |
|-----------|-----------------|-------|
| MongoDB | 7.0+ | New `portfolio_orders` collection with 5 indexes |
| Redis | 7.0+ | No changes |
| Frontend | 0.4.x+ | No API contract changes |

## Database Changes

### New Collections
- `portfolio_orders`: Stores order history with audit trail

### New Indexes
See "Order Persistence Infrastructure" section above for full index list.

## Known Issues

### Tool Execution Tracking (Non-blocking)
- **Status**: Infrastructure in place but not fully integrated
- **Reason**: Architectural mismatch between `ToolCacheWrapper` (requires explicit context) and LangGraph's autonomous tool management
- **Workaround**: Use Langfuse for tool observability (already configured)
- **Impact**: Non-blocking for MVP, tool calls still work normally

### Holdings Sync (Deferred)
- **Status**: Filled orders don't automatically create/update holdings documents
- **Reason**: Requires design decision (webhook vs. polling vs. manual reconciliation)
- **Workaround**: Use Alpaca positions API directly via `AlpacaTradingService.get_positions()`
- **Impact**: Portfolio positions visible but not cached in MongoDB

## Migration Guide

No migration required - this is a backward-compatible bug fix release.

**Deployment Steps**:
1. Backend version already bumped to v0.5.13
2. Build image: `az acr build --registry financialAgent --image klinematrix/backend:test-v0.5.13 --file backend/Dockerfile backend/`
3. Update `.pipeline/k8s/overlays/test/kustomization.yaml` with new version
4. Apply: `kubectl apply -k .pipeline/k8s/overlays/test`
5. Restart: `kubectl rollout restart deployment/backend -n klinematrix-test`
6. Verify: Check pod logs for "Portfolio order indexes created"

**Verification**:
```bash
# Check portfolio history endpoint
curl https://klinematrix.com/api/portfolio/history?period=1D

# Check order persistence (trigger watchlist analysis)
# Then verify in MongoDB:
kubectl exec -it deployment/mongodb -n klinematrix-test -- \
  mongosh financial_agent --eval "db.portfolio_orders.countDocuments({})"
```

## Performance Impact

- **Portfolio history API**: Improved from 30s timeout â†’ <1s response time
- **Agent queries**: Complex analyses now complete (previously failed at 25 iterations)
- **Database writes**: +1 write per order placement (minimal overhead)
