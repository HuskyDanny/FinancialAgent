# Backend v0.5.9

**Release Date**: 2025-10-26
**Docker Image**: `klinematrix/backend:test-v0.5.9`

## Overview

UX improvement release ensuring consistent response quality across v2 (Copilot) and v3 (Agent) modes by adding the same professional financial analyst system prompt to both modes.

## Features Added

- **Unified System Prompt for v3 (Agent Mode)**
  - Added `FINANCIAL_AGENT_SYSTEM_PROMPT` to LangGraph ReAct agent via `state_modifier` parameter
  - Ensures same "Senior financial analyst with 15+ years of Wall Street experience" persona across both modes
  - Consistent response style, formatting, and tone regardless of agent mode

## Technical Details

### Files Modified

**backend/src/agent/langgraph_react_agent.py** (`langgraph_react_agent.py:48, 139`)
- Import `FINANCIAL_AGENT_SYSTEM_PROMPT` from `llm_client`
- Pass system prompt to `create_react_agent()` via `state_modifier` parameter

### Before vs After

**Before (v0.5.8)**:
- v2 (Copilot): Custom financial analyst persona ✅
- v3 (Agent): Generic LangGraph ReAct prompt ❌ (focused on tool calling, not financial expertise)

**After (v0.5.9)**:
- v2 (Copilot): Custom financial analyst persona ✅
- v3 (Agent): Custom financial analyst persona ✅ (same as v2)

### System Prompt Features

The shared prompt provides:
- **Persona**: Senior financial analyst with 15+ years Wall Street experience
- **Response Style**: Adaptive (structured for initial analysis, conversational for follow-ups)
- **Writing Principles**: High signal-to-noise ratio, explain like teaching a smart friend
- **Technical Details**: Explain terms, reference exact price levels, maintain formatting consistency
- **Token Limits**: Target 500-1000 tokens, hard limit 3000 tokens

### LangGraph Integration

```python
self.agent = create_react_agent(
    self.llm,
    self.tools,
    checkpointer=self.checkpointer,
    prompt=FINANCIAL_AGENT_SYSTEM_PROMPT,  # ✅ Added
)
```

The `prompt` parameter in LangGraph allows injecting custom system prompts while preserving ReAct's tool-calling capabilities.

## Bug Fixes

- **LangGraph API Compatibility** (Critical)
  - Fixed parameter name from `state_modifier` to `prompt` in `create_react_agent()` call
  - `state_modifier` was incorrect parameter name causing TypeError on agent initialization
  - Corrected to use `prompt` parameter per LangGraph 0.2.x API specification
  - Without this fix, v3 (Agent mode) was completely broken with "Failed to fetch" errors

## Breaking Changes

None - existing v3 users will simply receive higher quality, more consistent responses.

## Compatibility

| Component | Required Version |
|-----------|-----------------|
| Frontend | v0.8.11+ (for agent mode toggle) |
| MongoDB | Cosmos DB (MongoDB 4.4+) |
| Redis | 6.0+ |

## Known Issues

None

## Migration Guide

No migration required. Existing v3 chats will automatically benefit from the improved system prompt.

**User Impact**:
- v3 (Agent) responses will be more professional, structured, and educational
- Consistent experience when switching between v2 and v3 modes
- Better alignment with user expectations for financial analysis quality
