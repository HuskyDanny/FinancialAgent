# Backend v0.5.8

**Release Date**: 2025-10-26
**Docker Image**: `klinematrix/backend:test-v0.5.8`

## Overview

Critical bug fix release that restores credit system functionality for both v2 (Copilot mode) and v3 (Agent mode) users. This release fixes complete absence of credit integration in both agent modes, preventing users from being charged for LLM usage.

## Bug Fixes

- **Critical: Credit system integration for v2 (Copilot mode)**
  - Added complete credit flow: balance check → PENDING transaction → LLM call → atomic deduction
  - Fixed streaming method to use correct `stream_chat()` API with conversation history
  - Integrated token usage tracking via `get_last_token_usage()`

- **Critical: Credit system integration for v3 (Agent mode)**
  - Added credit integration (was completely missing in v3)
  - Implemented token extraction from LangGraph AIMessage metadata
  - Added Tongyi/DashScope token format support (`token_usage` field)
  - Validates token extraction (fails transaction if 0 tokens)

- **Type safety: Fixed mypy errors**
  - Fixed `ChatAgent.stream_chat()` signature mismatch
  - Added type annotations for debug parameter conversion
  - Added type ignores for pre-existing union-attr issues

## Technical Details

### Files Modified

**backend/src/api/chat.py** (`chat.py:360-520`)
- `_stream_with_simple_agent`: Added credit integration for v2
- `_stream_with_react_agent`: Added credit integration for v3
- Fixed conversation history retrieval for v2 streaming

**backend/src/agent/langgraph_react_agent.py** (`langgraph_react_agent.py:370-414`)
- Token extraction from AIMessage metadata
- Support for both `usage_metadata` (newer LangChain) and `response_metadata.token_usage` (Tongyi/DashScope)
- Handles both `input_tokens`/`output_tokens` and `prompt_tokens`/`completion_tokens` field names

### Root Cause Analysis

1. **v2 Missing Credit Integration**: Complete credit flow was absent; users not charged
2. **v2 Streaming Method Error**: Used non-existent `astream()` method instead of `stream_chat()`
3. **v3 Missing Credit Integration**: No credit system at all in agent mode
4. **v3 Token Extraction Failure**: Didn't extract tokens from LangGraph metadata

### Testing Evidence

```
✅ Token extraction: input_tokens=679, output_tokens=9, total_tokens=688
✅ Transaction completed: actual_cost=0.56 credits
✅ Credit deduction: new_balance=624.62 credits
```

## Breaking Changes

None

## Compatibility

| Component | Required Version |
|-----------|-----------------|
| Frontend | v0.8.11 (for agent mode toggle UI) |
| MongoDB | Cosmos DB (MongoDB 4.4+) |
| Redis | 6.0+ |

## Known Issues

None

## Migration Guide

No migration required. Existing deployments will automatically benefit from credit integration after upgrading.

**⚠️ IMPORTANT**: This is a critical bug fix. Deploy immediately to prevent revenue loss from free LLM usage.
