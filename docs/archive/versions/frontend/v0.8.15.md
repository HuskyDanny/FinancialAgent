# Frontend v0.8.15

**Release Date**: 2025-11-12
**Type**: Bug Fix
**Status**: Released

## Overview

Fixed portfolio chat features failing in ACK production deployment due to incorrect environment variable usage. Standardized API URL configuration to use `VITE_API_URL` consistently across all frontend files.

## Bug Fixes

### API Configuration Standardization
- **Issue**: Portfolio chat, orders, and watchlist features used wrong environment variable (`VITE_API_BASE_URL`)
- **Impact**: Caused CORS errors in ACK deployment (localhost:8000 fallback from HTTPS origin)
- **Resolution**: Replaced `VITE_API_BASE_URL` with `VITE_API_URL` in 5 files

**Fixed Files**:
- `src/hooks/usePortfolioChats.ts:8`
- `src/hooks/usePortfolioChatDetail.ts:9`
- `src/hooks/usePortfolioOrders.ts:8`
- `src/components/portfolio/PortfolioChatSidebar.tsx:38`
- `src/services/watchlistApi.ts:8`

## Technical Details

### Environment Variable Behavior

| Environment | VITE_API_URL Value | Resolved Base URL |
|-------------|-------------------|-------------------|
| **Local Dev** | `undefined` | `http://localhost:8000` |
| **ACK Production** | `""` (empty string) | Relative URLs (proxy) |

### Root Cause

The Dockerfile sets `VITE_API_URL=""` for production builds to enable relative URL routing through nginx proxy. However, 5 files incorrectly referenced `VITE_API_BASE_URL` (which was never set), causing them to fall back to `http://localhost:8000` hardcoded default.

### CORS Error Details

```
Access to fetch at 'http://localhost:8000/api/portfolio/chat-history'
from origin 'https://klinecubic.cn' has been blocked by CORS policy:
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

## Testing

### Verification Steps

1. **Build**: New frontend image with corrected environment variable
2. **Deploy**: Update ACK production pods with new image
3. **Manual Test**:
   - Visit https://klinecubic.cn
   - Open browser DevTools Network tab
   - Navigate to portfolio section
   - Verify API calls use relative URLs (`/api/portfolio/...`)
   - Confirm no `localhost:8000` requests
   - Check portfolio chat history loads without CORS errors

### Expected Behavior

- ✅ All portfolio features accessible
- ✅ No CORS errors in browser console
- ✅ API calls resolved through nginx proxy
- ✅ Backend receives and responds to requests

## Deployment

**ACK Production**:
- Image: `financialagent-gxftdbbre4gtegea.azurecr.io/klinematrix/frontend:test-v0.8.15`
- Namespace: `klinematrix-prod`
- Command: `kubectl rollout restart deployment/frontend -n klinematrix-prod`

## Related Issues

- Portfolio chat history: Empty results due to localhost:8000 calls
- Symbol search: Unrelated issue (uses correct `services/api.ts` which already had `VITE_API_URL`)

## Notes

This fix only addresses the environment variable mismatch. Symbol search functionality requires separate investigation if still not working after this deployment.
