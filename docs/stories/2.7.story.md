# Story 2.7: Replace Yield Curve with Market Liquidity Metric

> **Story Type**: Enhancement (Replace Metric)
> **Epic**: [Market Insights Platform](../epics/market-insights-platform.md)
> **Created**: 2025-12-30
> **Status**: Ready for Review
> **Estimated Effort**: Medium (3-5 days)

---

## Story Goal

Replace the `yield_curve` (10Y-2Y spread) metric with a true **Market Liquidity** metric using FRED API data. The current yield_curve metric measures term structure/economic expectations, NOT actual market liquidity. This change aligns with professional liquidity assessment methodology.

---

## Background

### Why Replace yield_curve?

| Issue | Explanation |
|-------|-------------|
| **Not measuring liquidity** | 10Y-2Y spread measures term premium and growth expectations, not actual funds availability |
| **Indirect correlation** | A steep curve suggests loose policy, but doesn't confirm liquidity is abundant |
| **Theory mismatch** | Professional liquidity assessment uses overnight rates and RRP balance, not Treasury spreads |

### Professional Liquidity Theory (图片理论)

Key liquidity indicators used by professionals:
1. **隔夜拆借利率差值** (SOFR - EFFR Spread) - Stress in overnight funding
2. **逆回购规模** (Fed RRP Balance) - Excess liquidity in the system
3. **流动性趋势** (RRP 20-day change) - Direction of liquidity flow

**Core insight**:
- 当资金充裕 → 资产价格容易上升 → 容易出现泡沫 (HIGH liquidity = HIGH bubble risk)
- 当资金不充裕 → 就算市场情绪高涨 → 也不容易出现泡沫 (LOW liquidity = LOW bubble risk)

---

## Data Source Analysis

### Alpha Vantage (Current)

| Data | Available | Notes |
|------|-----------|-------|
| SOFR | ❌ | Not available |
| EFFR | ❌ | Not available |
| RRP Balance | ❌ | Not available |
| Federal Funds Rate | ✅ | But not sufficient alone |

### FRED API (Required)

| Series ID | Data | Frequency | URL |
|-----------|------|-----------|-----|
| `SOFR` | Secured Overnight Financing Rate | Daily | [Link](https://fred.stlouisfed.org/series/SOFR) |
| `EFFR` | Effective Federal Funds Rate | Daily | [Link](https://fred.stlouisfed.org/series/EFFR) |
| `RRPONTSYD` | Fed Reverse Repo Balance | Daily | [Link](https://fred.stlouisfed.org/series/RRPONTSYD) |

**FRED API**: Free tier available, requires API key registration.

---

## Technical Design

### 1. FRED Service Integration

```
backend/src/services/market_data/
├── __init__.py          # Add FREDService export
├── fred.py              # NEW: FRED API client
└── (existing files)
```

**New file: `fred.py`**

```python
"""FRED API integration for liquidity metrics."""

import pandas as pd
import structlog
from datetime import datetime, timedelta

logger = structlog.get_logger()

FRED_BASE_URL = "https://api.stlouisfed.org/fred/series/observations"


class FREDService:
    """FRED (Federal Reserve Economic Data) API client."""

    def __init__(self, api_key: str):
        self.api_key = api_key

    async def get_series(
        self,
        series_id: str,
        days: int = 60,
    ) -> pd.DataFrame:
        """
        Fetch FRED time series data.

        Args:
            series_id: FRED series identifier (e.g., "SOFR", "EFFR", "RRPONTSYD")
            days: Number of days of history to fetch

        Returns:
            DataFrame with date index and value column
        """
        # Implementation details...

    async def get_sofr(self, days: int = 60) -> pd.DataFrame:
        """Get Secured Overnight Financing Rate."""
        return await self.get_series("SOFR", days)

    async def get_effr(self, days: int = 60) -> pd.DataFrame:
        """Get Effective Federal Funds Rate."""
        return await self.get_series("EFFR", days)

    async def get_rrp_balance(self, days: int = 60) -> pd.DataFrame:
        """Get Fed Reverse Repo balance (in billions USD)."""
        return await self.get_series("RRPONTSYD", days)
```

### 2. New Metric: `market_liquidity`

**Replaces**: `yield_curve`

**Calculation Logic**:

```python
async def _calculate_market_liquidity(self) -> InsightMetric:
    """
    Calculate Market Liquidity score based on:

    1. RRP Balance (50% weight)
       - Measures excess liquidity in the financial system
       - High RRP ($1T+) = abundant liquidity = HIGH bubble risk
       - Low RRP (<$300B) = tight liquidity = LOW bubble risk

    2. SOFR-EFFR Spread (30% weight)
       - Measures stress in overnight funding markets
       - Normal (<5 bps): No stress → Score 50
       - Elevated (5-15 bps): Mild stress → Score 65
       - High (>15 bps): Funding stress → Score 80

    3. RRP 20-day Trend (20% weight)
       - Rising RRP: Liquidity increasing → Higher bubble risk
       - Falling RRP: Liquidity draining → Lower bubble risk

    Final Score Mapping:
    - Abundant liquidity → HIGH score (bubble CAN form easily)
    - Tight liquidity → LOW score (bubble CANNOT form easily)
    """

    # Component 1: RRP Balance (50%)
    rrp_df = await self.fred_service.get_rrp_balance(days=30)
    current_rrp = rrp_df["value"].iloc[-1]  # In billions

    # RRP ranges: $0-2T maps to 0-100
    # Higher RRP = more liquidity = higher bubble risk
    rrp_score = normalize_score(current_rrp, 0, 2000)

    # Component 2: SOFR-EFFR Spread (30%)
    sofr_df = await self.fred_service.get_sofr(days=5)
    effr_df = await self.fred_service.get_effr(days=5)

    sofr = sofr_df["value"].iloc[-1]
    effr = effr_df["value"].iloc[-1]
    spread_bps = (sofr - effr) * 100  # Convert to basis points

    # Spread interpretation:
    # <5 bps: Normal, healthy funding → lower risk
    # 5-15 bps: Mild stress → moderate risk
    # >15 bps: Funding stress → higher risk (but less bubble risk)
    # Note: High spread = stress = LESS bubble risk
    spread_score = 50 - normalize_score(abs(spread_bps), 0, 20) * 0.3

    # Component 3: RRP 20-day Trend (20%)
    rrp_20d_ago = rrp_df["value"].iloc[-20] if len(rrp_df) >= 20 else rrp_df["value"].iloc[0]
    rrp_change = current_rrp - rrp_20d_ago
    rrp_change_pct = (rrp_change / rrp_20d_ago) * 100 if rrp_20d_ago > 0 else 0

    # Rising RRP = more liquidity = higher bubble risk
    trend_score = normalize_score(rrp_change_pct, -20, 20)

    # Final weighted score
    final_score = (
        rrp_score * 0.50 +
        spread_score * 0.30 +
        trend_score * 0.20
    )

    return InsightMetric(
        id="market_liquidity",
        name="Market Liquidity",
        score=final_score,
        # ... explanation details
    )
```

### 3. Weight Rebalancing

| Metric | Old Weight | New Weight | Change |
|--------|------------|------------|--------|
| `ai_price_anomaly` | 20% | 20% | - |
| `news_sentiment` | 20% | 20% | - |
| `smart_money_flow` | 20% | 20% | - |
| `ipo_heat` | 10% | 10% | - |
| `yield_curve` | 15% | **REMOVED** | -15% |
| `fed_expectations` | 15% | 15% | - |
| `market_liquidity` | N/A | **15%** | +15% |

**Total**: 100%

### 4. Configuration Changes

```python
# backend/src/core/config.py
class Settings(BaseSettings):
    # ... existing settings

    # FRED API (NEW)
    FRED_API_KEY: str = Field(default="", env="FRED_API_KEY")
    FRED_BASE_URL: str = "https://api.stlouisfed.org/fred"
```

```bash
# .env.development, .env.production
FRED_API_KEY=your_fred_api_key_here
```

### 5. Kubernetes Secrets

```yaml
# .pipeline/k8s/overlays/prod/backend-prod-patch.yaml
- name: FRED_API_KEY
  valueFrom:
    secretKeyRef:
      name: backend-secrets
      key: FRED_API_KEY
```

---

## Explanation Template

```python
MetricExplanation(
    summary=f"System liquidity is {'abundant' if score > 60 else 'normal' if score > 40 else 'tight'} (RRP: ${current_rrp:.0f}B).",
    detail=(
        f"Fed Reverse Repo balance: ${current_rrp:.0f}B "
        f"({'↑' if rrp_change > 0 else '↓'}{abs(rrp_change_pct):.1f}% vs 20d ago). "
        f"SOFR-EFFR spread: {spread_bps:.1f} bps. "
        f"{'Abundant liquidity provides fuel for asset bubbles.' if score > 60 else 'Liquidity conditions are balanced.' if score > 40 else 'Tight liquidity constrains bubble formation.'}"
    ),
    methodology=(
        "Measures actual market liquidity using Fed Reverse Repo (RRP) balance and "
        "overnight funding spreads (SOFR-EFFR). High RRP indicates excess cash in the "
        "system seeking safe parking, which historically correlates with risk asset rallies. "
        "The SOFR-EFFR spread detects stress in overnight funding markets."
    ),
    formula="Score = RRP_Score×0.5 + Spread_Score×0.3 + Trend_Score×0.2",
    historical_context=(
        f"RRP peaked at $2.5T in Dec 2022 (extreme liquidity). "
        f"Current: ${current_rrp:.0f}B. "
        f"Low RRP (<$300B) historically coincides with market stress."
    ),
    actionable_insight=(
        "Abundant liquidity supports risk assets - bubbles can form."
        if score > 60
        else "Normal liquidity conditions - standard risk management."
        if score > 40
        else "Tight liquidity constrains bubble formation - watch for stress signals."
    ),
)
```

---

## Migration Plan

### Step 1: Add FRED Service (Non-breaking)
- Create `fred.py` service
- Add configuration
- Unit tests with mocked responses

### Step 2: Add market_liquidity Metric (Parallel)
- Add new metric alongside yield_curve
- Verify data fetching works
- Test in dev environment

### Step 3: Replace yield_curve (Breaking)
- Remove yield_curve from metric definitions
- Update weights
- Update frontend if needed (metric card count)

### Step 4: Deploy & Monitor
- Deploy to production
- Monitor FRED API rate limits
- Verify snapshot cron captures new metric

---

## Acceptance Criteria

- [x] FRED API service created with `get_sofr()`, `get_effr()`, `get_rrp_balance()` methods
- [x] `market_liquidity` metric replaces `yield_curve` in AI Sector Risk
- [x] Calculation uses 3 components: RRP balance (50%), SOFR-EFFR spread (30%), RRP trend (20%)
- [x] Logic: High liquidity → High bubble risk score (aligned with theory)
- [ ] FRED API key added to secrets (Azure Key Vault + K8s) *(needs deployment)*
- [ ] Redis cache for FRED data (1 hour TTL) *(handled by existing category caching)*
- [x] Unit tests with mocked FRED API responses
- [x] Graceful fallback if FRED API unavailable (placeholder score)
- [ ] Documentation updated (epic, feature doc)
- [ ] Daily snapshot cron captures new metric correctly *(needs deployment verification)*

---

## Verification

```bash
# 1. Test FRED API connectivity
curl "https://api.stlouisfed.org/fred/series/observations?series_id=RRPONTSYD&api_key=$FRED_API_KEY&file_type=json&limit=5&sort_order=desc"

# 2. Check local API
curl -s http://localhost:8000/api/insights/ai_sector_risk | jq '.metrics[] | select(.id == "market_liquidity")'

# 3. Verify yield_curve removed
curl -s http://localhost:8000/api/insights/ai_sector_risk | jq '.metrics[] | select(.id == "yield_curve")'
# Expected: empty/null

# 4. Verify 6 metrics returned (not 7, since we replaced)
curl -s http://localhost:8000/api/insights/ai_sector_risk | jq '.metrics | length'
# Expected: 6

# 5. Production verification
curl -s https://klinecubic.cn/api/insights/ai_sector_risk | jq '.metrics | map(.id)'
# Expected: ["ai_price_anomaly", "news_sentiment", "smart_money_flow", "market_liquidity", "ipo_heat", "fed_expectations"]
```

---

## Risk Mitigation

| Risk | Mitigation | Rollback |
|------|------------|----------|
| FRED API rate limit | Cache aggressively (1hr TTL), daily cron pre-fetches | Use placeholder score |
| FRED API downtime | Graceful fallback with cached/placeholder data | Revert to yield_curve |
| Data format changes | Validate response schema | Alert + manual review |
| Incorrect interpretation | Unit tests with known values | Review calculation logic |

---

## Dependencies

- **Story 2.5**: Frontend trend visualization (may need metric card update if count changes)
- **Story 2.8 (Cron)**: Daily snapshot must capture new metric

---

## Out of Scope

- Adding additional FRED metrics (M2 money supply, etc.)
- Replacing `fed_expectations` metric (keep as-is for now)
- Historical backfill of `market_liquidity` data

---

## References

- [FRED API Documentation](https://fred.stlouisfed.org/docs/api/fred/)
- [FRED SOFR Series](https://fred.stlouisfed.org/series/SOFR)
- [FRED EFFR Series](https://fred.stlouisfed.org/series/EFFR)
- [FRED RRP Series](https://fred.stlouisfed.org/series/RRPONTSYD)
- [NY Fed Markets Data API](https://markets.newyorkfed.org/static/docs/markets-api.html)

---

## Dev Agent Record

### File List

**Created:**
- `backend/src/services/market_data/fred.py` - FRED API service with get_sofr, get_effr, get_rrp_balance methods
- `backend/tests/test_fred_service.py` - Comprehensive unit tests for FREDService

**Modified:**
- `backend/src/core/config.py` - Added `fred_api_key` configuration setting
- `backend/src/services/market_data/__init__.py` - Export FREDService
- `backend/src/services/insights/base.py` - Accept `fred_service` parameter
- `backend/src/services/insights/registry.py` - Pass `fred_service` to categories
- `backend/src/services/insights/snapshot_service.py` - Create and inject FREDService
- `backend/src/services/insights/categories/ai_sector_risk.py` - Replace yield_curve with market_liquidity metric
- `backend/src/main.py` - Initialize FREDService at app startup
- `backend/src/agent/langgraph_react_agent.py` - Create FREDService for agent insights
- `backend/tests/test_insights_service.py` - Update expected metric IDs
- `backend/tests/test_ai_sector_risk_logic.py` - Add TestMarketLiquidityLogic test class

### Change Log

| Date | Change | Reason |
|------|--------|--------|
| 2025-12-30 | Created FREDService class | Provide access to SOFR, EFFR, RRP data from FRED API |
| 2025-12-30 | Replaced yield_curve with market_liquidity metric | Better measure of actual market liquidity per professional theory |
| 2025-12-30 | Updated composite weights (13% for market_liquidity) | Maintain 100% total after metric replacement |
| 2025-12-30 | Added unit tests for FRED service and market_liquidity | Ensure correctness of calculation logic |

### Completion Notes

**Implementation Summary:**
1. **FREDService** (`fred.py`): Async HTTP client for FRED API with automatic date filtering, error handling, and response parsing. Returns pandas DataFrames with date index and value column.

2. **Market Liquidity Metric**: Three-component calculation aligned with professional liquidity theory:
   - **RRP Balance (50%)**: High RRP ($1T+) = abundant liquidity = HIGH bubble risk
   - **SOFR-EFFR Spread (30%)**: Low spread = no funding stress = bubble can form; High spread = stress = less bubble risk (inverted)
   - **RRP 20-day Trend (20%)**: Rising RRP = increasing liquidity = higher risk

3. **Graceful Fallback**: If FRED service unavailable, returns placeholder metric with score=50 and explanatory message.

4. **Test Coverage**: 47 tests for FRED service and market liquidity logic, all passing. Full suite: 920 tests passed.

### Debug Log References

- N/A (no significant debugging required)

### Agent Model Used

- Claude Opus 4.5 (claude-opus-4-5-20251101)
