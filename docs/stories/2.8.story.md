# Story 2.8: Reusable Put/Call Ratio Service with AI Tool

> **Story Type**: Enhancement (AI Tool + Service Refactor)
> **Epic**: [Market Insights Platform](../epics/market-insights-platform.md)
> **Created**: 2025-12-31
> **Status**: Complete
> **Estimated Effort**: Medium (2-3 days)

---

## Story Goal

Create a reusable Put/Call Ratio (PCR) calculation service that:
1. Can be invoked by AI agent as a tool for individual symbols
2. Used by AI Sector Risk metric for basket calculation (top 10 symbols)
3. Caches individual symbol results in Redis for 1-hour reuse

---

## Background

### Current State (Story 2.6)
- AI Sector Risk has `options_put_call_ratio` metric
- Calculates PCR for top 10 AI basket symbols inline
- No per-symbol caching - recalculates on every request
- Not accessible as standalone AI tool

### Desired State (Story 2.8)
- Shared `DataManager.get_symbol_pcr()` service method
- Individual symbol results cached in Redis (1-hour TTL)
- AI agent can query PCR for any symbol via tool
- AI Sector Risk reuses cached results

---

## Technical Design

### Redis Data Structure

**Cache Key Pattern:**
```
market:pcr:{SYMBOL}  â†’  SymbolPCRData (JSON)
```

**TTL:** 3600 seconds (1 hour) - same as TTL_OPTIONS

### SymbolPCRData Dataclass

```python
@dataclass
class SymbolPCRData:
    symbol: str
    current_price: float
    atm_zone_low: float
    atm_zone_high: float
    put_notional_mm: float      # Millions USD
    call_notional_mm: float     # Millions USD
    contracts_analyzed: int
    pcr: float
    interpretation: str
    calculated_at: datetime
    atm_zone_pct: float = 0.15  # Â±15% of price
    min_premium: float = 0.50   # $0.50 minimum
    min_oi: int = 500           # 500 contracts minimum
```

### AI Tool: `get_put_call_ratio`

```python
@tool
async def get_put_call_ratio(symbol: str) -> str:
    """
    Get the Put/Call Ratio for a stock symbol.

    Calculates ATM (at-the-money) dollar-weighted Put/Call Ratio:
    - Filters to options within 15% of current price
    - Requires minimum $0.50 premium and 500 open interest
    - Uses notional value: OI x Premium x 100

    PCR Interpretation (Contrarian):
    - PCR < 0.5: Extreme bullish sentiment -> Contrarian bearish signal
    - PCR 0.5-0.7: Bullish sentiment -> Cautionary signal
    - PCR 0.7-1.0: Moderate bullish -> Neutral
    - PCR 1.0-1.3: Moderate bearish -> Neutral
    - PCR 1.3-1.5: Bearish sentiment -> Contrarian optimistic
    - PCR > 1.5: Extreme fear -> Contrarian bullish signal
    """
```

### Flow Diagram

```
AI Agent calls:                  AI Sector Risk Metric calls:
get_put_call_ratio("NVDA")       _calculate_options_put_call_ratio()
        â”‚                                  â”‚
        â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           DataManager.get_symbol_pcr(symbol)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ Redis HIT (market:pcr:NVDA)
        â”‚   â””â”€â”€ Return cached SymbolPCRData (3ms)
        â”‚
        â””â”€â”€ Redis MISS
            â”œâ”€â”€ get_quote(symbol) â†’ current price
            â”œâ”€â”€ get_options(symbol) â†’ contracts
            â”œâ”€â”€ Filter ATM zone Â±15%, min $0.50, min OI 500
            â”œâ”€â”€ Calculate notionals & PCR
            â”œâ”€â”€ Store in Redis (TTL: 1hr)
            â””â”€â”€ Return SymbolPCRData (~2500ms)
```

---

## Acceptance Criteria

- [x] `SymbolPCRData` dataclass added to `data_manager/types.py`
- [x] `CacheKeys.pcr_symbol()` method added to `data_manager/keys.py`
- [x] `DataManager.get_symbol_pcr()` method with Redis caching (1hr TTL)
- [x] `get_put_call_ratio` AI tool created in `agent/tools/pcr_tools.py`
- [x] Tool registered with LangGraph agent (19 total tools)
- [x] AI Sector Risk metric refactored to use `get_symbol_pcr()`
- [x] Rich markdown output with price, ATM zone, notionals, interpretation
- [x] Unit tests for tool and data manager (`test_pcr_tools.py`, `test_data_manager.py`)
- [x] Cache HIT returns in <10ms (verified: 3ms)
- [x] Cache MISS fetches real data (~2500ms)

---

## Files Modified

| File | Action |
|------|--------|
| `backend/src/services/data_manager/types.py` | Add SymbolPCRData dataclass |
| `backend/src/services/data_manager/keys.py` | Add pcr_symbol() method |
| `backend/src/services/data_manager/manager.py` | Add get_symbol_pcr(), TTL_PCR |
| `backend/src/services/data_manager/__init__.py` | Export SymbolPCRData |
| `backend/src/agent/tools/pcr_tools.py` | **NEW** - AI tool |
| `backend/src/agent/tools/__init__.py` | Export create_pcr_tools |
| `backend/src/agent/langgraph_react_agent.py` | Register PCR tools |
| `backend/src/services/insights/categories/ai_sector_risk.py` | Use cached get_symbol_pcr() |
| `backend/tests/test_data_manager.py` | Add SymbolPCRData tests |
| `backend/tests/test_pcr_tools.py` | **NEW** - Tool tests |

---

## Verification

### Unit Tests
```bash
cd backend && make test
# 941 tests passed including:
# - test_pcr_tools.py (15 tests)
# - test_data_manager.py (60 tests with SymbolPCRData)
```

### E2E Testing (HarshJudge)

**Scenario**: `story-2-8-pcr-tool-cache`
**Run ID**: `ILC2Fhh8r3`
**Status**: âœ… PASSED (6/6 steps)

| Step | Test | Result |
|------|------|--------|
| 1 | Health check (Redis connected) | âœ… Pass |
| 2 | Clear PCR cache keys | âœ… Pass |
| 3 | Invoke PCR tool (NVDA) - Cache MISS | âœ… Pass (2528ms, PCR=0.30) |
| 4 | Verify Redis cache populated | âœ… Pass (TTL=3600s) |
| 5 | Invoke PCR tool again - Cache HIT | âœ… Pass (3ms, 843x faster) |
| 6 | Test different symbol (AAPL) | âœ… Pass (PCR=0.15, separate cache) |

### Manual API Test
```bash
# Via chat API
curl -X POST "http://localhost:8000/api/chat/stream" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"message":"What is the put/call ratio for NVDA?"}'

# Response includes tool execution:
# - Tool: get_put_call_ratio
# - Symbol: NVDA
# - PCR: 0.30
# - Rich markdown output with ATM zone, notionals, interpretation
```

---

## Performance Results

| Metric | Cache MISS | Cache HIT | Improvement |
|--------|------------|-----------|-------------|
| Duration | 2528ms | 3ms | **843x faster** |
| Redis Ops | 1 SET | 1 GET | - |
| API Calls | Quote + Options | 0 | - |

---

## Dev Agent Record

### Change Log

| Date | Change | Reason |
|------|--------|--------|
| 2025-12-31 | Created SymbolPCRData dataclass | Store per-symbol PCR calculation results |
| 2025-12-31 | Added get_symbol_pcr() to DataManager | Centralized PCR calculation with caching |
| 2025-12-31 | Created pcr_tools.py with get_put_call_ratio | AI agent access to PCR data |
| 2025-12-31 | Registered PCR tools with agent | Tool count: 18 â†’ 19 |
| 2025-12-31 | Added unit tests | 15 tests for tool, dataclass tests in data_manager |
| 2025-12-31 | HarshJudge E2E verified | All 6 steps passed |

### Completion Notes

**Implementation Summary:**
1. **SymbolPCRData**: Dataclass with JSON serialization (to_dict/from_dict) for Redis storage
2. **DataManager.get_symbol_pcr()**: Cache-through pattern with distributed lock to prevent thundering herd
3. **AI Tool**: Rich markdown output with sentiment emoji (ğŸŸ¢ğŸ”µğŸŸ ğŸ”´), tables, methodology
4. **AI Sector Risk**: Refactored to call get_symbol_pcr() for each of top 10 symbols, aggregating notionals

**Key Design Decisions:**
- 1-hour TTL balances freshness vs API rate limits
- ATM zone Â±15% filters out illiquid far-OTM options
- Min premium $0.50 + min OI 500 ensures quality data
- Distributed lock prevents duplicate fetches on cache miss

### Agent Model Used

- Claude Opus 4.5 (claude-opus-4-5-20251101)
