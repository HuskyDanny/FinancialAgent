name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  # 1. Enforce branch naming policy
  branch-policy:
    name: Branch Policy
    runs-on: ubuntu-latest
    steps:
      - name: Validate Branch Name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "üîç Checking branch: $BRANCH_NAME"

          if [[ ! "$BRANCH_NAME" =~ ^users/[^/]+/.+$ ]]; then
            echo ""
            echo "‚ùå Branch naming violation!"
            echo ""
            echo "Your branch: $BRANCH_NAME"
            echo "Required format: users/{username}/{feature-name}"
            echo ""
            echo "Examples:"
            echo "  ‚úì users/danny/add-dark-mode"
            echo "  ‚úì users/allen/fix-login-bug"
            echo "  ‚úì users/john/feature/new-dashboard"
            echo ""
            echo "Please rename your branch:"
            echo "  git branch -m $BRANCH_NAME users/YOUR_NAME/YOUR_FEATURE"
            echo "  git push origin -u users/YOUR_NAME/YOUR_FEATURE"
            echo "  git push origin --delete $BRANCH_NAME"
            exit 1
          fi

          echo "‚úÖ Branch name is valid: $BRANCH_NAME"

  # 2. Run unit tests (required status check)
  unit-tests:
    name: Unit Tests
    needs: branch-policy
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install -e ".[dev]"
          # Debug: Check package structure
          echo "=== Checking package structure ==="
          ls -la src/services/
          ls -la src/services/market_data/ || echo "market_data not found"
          python -c "import src; print('src imported:', src.__file__)"
          python -c "import src.services; print('src.services imported:', src.services.__file__)"
          python -c "from src.services.market_data import AlphaVantageMarketDataService; print('market_data imported successfully')"

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci

      - name: Run Backend Tests
        env:
          MONGODB_URL: mongodb://localhost:27017/test
          REDIS_URL: redis://localhost:6379
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short

      - name: Run Frontend Tests
        run: |
          cd frontend
          npm test -- --watchAll=false --passWithNoTests

      - name: Lint Backend
        run: |
          cd backend
          python -m ruff check src/
          python -m black --check src/

      - name: Lint Frontend
        run: |
          cd frontend
          npm run lint
          npm run type-check

  # 3. AI-powered PR description (runs parallel to tests)
  # Note: Using coderabbitai for AI review - install via GitHub marketplace
  ai-summary:
    name: AI Summary
    needs: branch-policy
    runs-on: ubuntu-latest
    # Don't fail the PR if AI summary fails
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR Summary Placeholder
        run: |
          echo "‚úÖ AI Summary job completed"
          echo ""
          echo "For AI-powered PR reviews, consider installing:"
          echo "- CodeRabbit: https://coderabbit.ai"
          echo "- GitHub Copilot for PRs"
          echo ""
          echo "This placeholder ensures the workflow completes successfully."
