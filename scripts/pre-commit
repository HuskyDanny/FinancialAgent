#!/bin/bash
# Pre-commit hook for Financial Agent
# Runs both backend and frontend unit tests before allowing commit

echo "ğŸ” Pre-commit hook: Running tests..."
echo ""

# Track overall success
TESTS_PASSED=true

# ===== Backend Tests =====
echo "ğŸ Running backend unit tests..."
echo ""

# Run backend tests locally (not in Docker to avoid complexity)
cd backend || exit 1
if python -m pytest tests/ -q --tb=short 2>&1; then
    echo ""
    echo "âœ… Backend tests passed"
    BACKEND_SUCCESS=true
else
    echo ""
    echo "âŒ Backend tests failed"
    BACKEND_SUCCESS=false
    TESTS_PASSED=false
fi
cd .. || exit 1

echo ""

# ===== Frontend Tests =====
echo "âš›ï¸  Running frontend unit tests..."
echo ""

# Run frontend tests via Docker Compose
if docker-compose exec -T frontend npm test -- --run --reporter=basic 2>&1; then
    echo ""
    echo "âœ… Frontend tests passed"
    FRONTEND_SUCCESS=true
else
    echo ""
    echo "âŒ Frontend tests failed"
    FRONTEND_SUCCESS=false
    TESTS_PASSED=false
fi

echo ""

# ===== Summary =====
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ "$BACKEND_SUCCESS" = true ]; then
    echo "âœ… Backend:  PASSED"
else
    echo "âŒ Backend:  FAILED"
fi

if [ "$FRONTEND_SUCCESS" = true ]; then
    echo "âœ… Frontend: PASSED"
else
    echo "âŒ Frontend: FAILED"
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ===== Final Result =====
if [ "$TESTS_PASSED" = false ]; then
    echo "âŒ COMMIT BLOCKED: Tests failed"
    echo ""
    echo "Fix the failing tests before committing."
    echo "Run 'make test' to see detailed output."
    echo ""
    exit 1
fi

echo "âœ… All tests passed - commit allowed"
echo ""
exit 0
